<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>F1 Pomodoro</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');

  :root {
    --track-color: #E8003D;
    --track-glow: rgba(232,0,61,0.4);
    --surface: #0a0a12;
    --text: #f0f0f0;
    --dim: #44445a;
    --green: #00D2BE;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: var(--surface); }
  body { color: var(--text); font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; height: 100dvh; }

  .header { display: flex; align-items: center; justify-content: space-between; padding: 52px 22px 8px; flex-shrink: 0; position: relative; z-index: 50; }

  .circuit-selector { position: relative; flex: 1; margin-right: 12px; }
  .circuit-btn { display: flex; align-items: center; gap: 8px; background: none; border: none; cursor: pointer; font-family: 'Orbitron', monospace; font-size: 13px; font-weight: 700; letter-spacing: 0.15em; color: var(--track-color); text-transform: uppercase; padding: 0; }
  .circuit-arrow { font-size: 9px; color: var(--track-color); transition: transform 0.2s; display: inline-block; }
  .circuit-arrow.open { transform: rotate(180deg); }

  .circuit-dropdown { position: absolute; top: calc(100% + 8px); left: 0; background: #13131e; border: 1px solid #2a2a3e; border-radius: 14px; overflow: hidden; display: none; flex-direction: column; z-index: 100; min-width: 260px; box-shadow: 0 12px 40px rgba(0,0,0,0.8); }
  .circuit-dropdown.open { display: flex; }
  .dropdown-page { display: flex; flex-direction: column; }
  .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 11px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.15s; }
  .dropdown-item:last-child { border-bottom: none; }
  .dropdown-item:hover, .dropdown-item:active { background: rgba(255,255,255,0.06); }
  .dropdown-item.active { background: rgba(255,255,255,0.09); }
  .dropdown-flag { font-size: 16px; flex-shrink: 0; }
  .dropdown-name { font-family: 'Rajdhani', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); letter-spacing: 0.05em; flex: 1; }
  .dropdown-round { font-family: 'Orbitron', monospace; font-size: 8px; color: var(--dim); letter-spacing: 0.1em; }
  .dropdown-nav { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; border-top: 1px solid rgba(255,255,255,0.06); background: #0e0e1a; }
  .nav-btn { background: none; border: 1px solid #2a2a3e; border-radius: 6px; color: var(--dim); font-family: 'Orbitron', monospace; font-size: 9px; padding: 5px 12px; cursor: pointer; transition: all 0.15s; letter-spacing: 0.05em; }
  .nav-btn:hover { border-color: var(--track-color); color: var(--track-color); }
  .nav-btn:disabled { opacity: 0.2; cursor: default; }
  .nav-page { font-family: 'Orbitron', monospace; font-size: 8px; color: var(--dim); letter-spacing: 0.1em; }

  .lap-dots { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
  .lap-dot { width: 8px; height: 8px; border-radius: 50%; background: #1e1e2e; border: 1px solid #2a2a3e; transition: all 0.4s; }
  .lap-dot.done { background: var(--track-color); border-color: var(--track-color); box-shadow: 0 0 6px var(--track-color); }
  .lap-dot.active { background: var(--green); border-color: var(--green); box-shadow: 0 0 8px var(--green); animation: dotpulse 1s ease-in-out infinite; }
  @keyframes dotpulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .circuit-container { flex: 1; position: relative; padding: 4px 10px; min-height: 0; display: flex; align-items: center; justify-content: center; }
  #circuit-svg { width: 100%; height: 100%; overflow: visible; max-height: 100%; }

  .stats { padding: 10px 22px; display: flex; flex-shrink: 0; border-top: 1px solid rgba(255,255,255,0.05); }
  .stat { flex: 1; display: flex; flex-direction: column; gap: 2px; align-items: center; }
  .stat:nth-child(2) { border-left: 1px solid rgba(255,255,255,0.06); border-right: 1px solid rgba(255,255,255,0.06); }
  .stat-label { font-size: 9px; letter-spacing: 0.18em; color: var(--dim); text-transform: uppercase; font-weight: 700; text-align: center; }
  .stat-value { font-family: 'Orbitron', monospace; font-size: 15px; font-weight: 700; color: var(--text); letter-spacing: 0.04em; text-align: center; }
  .stat-value.accent { color: var(--track-color); }
  .stat-value.green { color: var(--green); }

  .timer-row { padding: 8px 22px 4px; display: flex; align-items: center; flex-shrink: 0; }
  .timer-input-wrap { display: flex; align-items: center; justify-content: center; background: #141420; border: 1px solid #22223a; border-radius: 10px; padding: 8px 14px; flex: 1; }
  .timer-input-wrap label { font-size: 9px; letter-spacing: 0.15em; color: var(--dim); text-transform: uppercase; font-weight: 700; margin-right: 10px; }
  .time-field { display: flex; flex-direction: column; align-items: center; gap: 1px; }
  .time-field-label { font-size: 7px; letter-spacing: 0.1em; color: var(--dim); text-transform: uppercase; font-weight: 700; }
  .timer-input-wrap input[type=number] { background: none; border: none; color: var(--text); font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 700; width: 32px; text-align: center; outline: none; -moz-appearance: textfield; }
  .timer-input-wrap input::-webkit-inner-spin-button { display: none; }
  .timer-sep { font-family: 'Orbitron', monospace; font-size: 18px; color: var(--dim); margin: 0 3px; padding-bottom: 12px; }

  .controls { padding: 6px 22px 20px; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
  .btn { font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 900; letter-spacing: 0.12em; padding: 12px 0; border-radius: 10px; border: none; cursor: pointer; text-transform: uppercase; transition: all 0.15s; }
  .btn-primary { background: var(--track-color); color: white; flex: 1; box-shadow: 0 0 20px var(--track-glow); }
  .btn-ghost { background: #141420; color: var(--dim); border: 1px solid #22223a; padding: 12px 16px; }

  .palette-wrap { position: relative; display: flex; align-items: center; }
  .palette-btn { width: 34px; height: 34px; border-radius: 50%; background: var(--track-color); border: 2px solid rgba(255,255,255,0.2); cursor: pointer; box-shadow: 0 0 12px var(--track-glow); transition: all 0.2s; flex-shrink: 0; }
  .palette-popup { position: absolute; bottom: 50px; right: 0; background: #141420; border: 1px solid #2a2a3e; border-radius: 16px; padding: 14px; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px 8px; z-index: 30; box-shadow: 0 -10px 36px rgba(0,0,0,0.8); width: 230px; }
  .palette-popup.open { display: grid; }
  .team-swatch { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
  .swatch-dot { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.12); transition: all 0.15s; }
  .swatch-dot:active { transform: scale(1.15); }
  .swatch-dot.selected { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.6); transform: scale(1.12); }
  .swatch-label { font-size: 8px; letter-spacing: 0.02em; color: #bbb; text-align: center; font-family: 'Rajdhani',sans-serif; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 40px; }

  .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
  .overlay.active { opacity: 1; pointer-events: all; }
  .overlay-pitstop { background: rgba(5,5,12,0.95); backdrop-filter: blur(10px); }
  .overlay-finish  { background: rgba(5,5,12,0.92); backdrop-filter: blur(8px); }

  .pit-label { font-family: 'Orbitron', monospace; font-size: 30px; letter-spacing: 0.2em; color: white; font-weight: 900; }
  .btn-back { font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 900; letter-spacing: 0.15em; padding: 14px 34px; border-radius: 10px; border: 2px solid var(--green); background: transparent; color: var(--green); cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
  .btn-back:hover { background: var(--green); color: #000; }
  .btn-finish-back { font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 900; letter-spacing: 0.15em; padding: 14px 34px; border-radius: 10px; border: 2px solid var(--track-color); background: transparent; color: var(--track-color); cursor: pointer; text-transform: uppercase; transition: all 0.2s; box-shadow: 0 0 20px var(--track-glow); }
  .btn-finish-back:hover { background: var(--track-color); color: #000; }

  .tire-wrap { position: relative; width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; }
  .tire-outer { position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(circle at 30% 28%, #4a4a4a 0%, #1c1c1c 55%, #0e0e0e 100%); box-shadow: inset 0 0 14px rgba(0,0,0,0.8), 0 0 22px rgba(0,0,0,0.6); }
  .tire-outer::before { content: ''; position: absolute; inset: 6px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.05); }
  .tire-rim { position: absolute; inset: 20px; border-radius: 50%; background: radial-gradient(circle at 38% 35%, #888 0%, #444 40%, #222 100%); box-shadow: inset 0 2px 6px rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
  .tire-rim::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg 25deg, rgba(0,0,0,0.5) 25deg 60deg, transparent 60deg 85deg, rgba(0,0,0,0.5) 85deg 120deg, transparent 120deg 145deg, rgba(0,0,0,0.5) 145deg 180deg, transparent 180deg 205deg, rgba(0,0,0,0.5) 205deg 240deg, transparent 240deg 265deg, rgba(0,0,0,0.5) 265deg 300deg, transparent 300deg 325deg, rgba(0,0,0,0.5) 325deg 360deg); border-radius: 50%; }
  .tire-hub { width: 24px; height: 24px; border-radius: 50%; background: radial-gradient(circle at 40% 38%, #bbb, #555); box-shadow: 0 0 0 3px rgba(0,0,0,0.4); position: relative; z-index: 2; }
  .tire-spinning-group { position: absolute; inset: 0; border-radius: 50%; animation: pit-spin-full 1.5s linear infinite; }
  @keyframes pit-spin-full { 0%{transform:rotate(0deg);animation-timing-function:cubic-bezier(0.15,0,0.25,1)} 52%{transform:rotate(720deg);animation-timing-function:steps(1,end)} 68%{transform:rotate(720deg)} 100%{transform:rotate(720deg)} }

  #flag-canvas { border-radius: 4px; box-shadow: 4px 6px 20px rgba(0,0,0,0.7); }
  .winner-text { font-family: 'Orbitron', monospace; font-size: 22px; font-weight: 900; letter-spacing: 0.12em; color: white; text-transform: uppercase; text-align: center; line-height: 1.3; }
  .race-completed { font-family: 'Orbitron', monospace; font-size: 10px; font-weight: 400; letter-spacing: 0.28em; color: rgba(255,255,255,0.5); text-transform: uppercase; text-align: center; margin-top: -10px; }

  #confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 250; display: none; }
</style>
</head>
<body>

<div class="header">
  <div class="circuit-selector">
    <button class="circuit-btn" id="circuit-btn">
      <span id="circuit-flag">ðŸ‡²ðŸ‡¨</span>
      <span id="circuit-title">Monaco GP</span>
      <span class="circuit-arrow" id="circuit-arrow">â–¼</span>
    </button>
    <div class="circuit-dropdown" id="circuit-dropdown">
      <div class="dropdown-page" id="dropdown-page"></div>
      <div class="dropdown-nav">
        <button class="nav-btn" id="nav-prev">â—€ PREV</button>
        <span class="nav-page" id="nav-page">1 / 4</span>
        <button class="nav-btn" id="nav-next">NEXT â–¶</button>
      </div>
    </div>
  </div>
  <div class="lap-dots" id="lap-dots"></div>
</div>

<div class="circuit-container">
  <svg id="circuit-svg" viewBox="0 0 370 210" preserveAspectRatio="xMidYMid meet" style="display:block;">
    <defs>
      <filter id="glow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      <filter id="glow-strong"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <path id="path-shadow"  fill="none" stroke="#181826" stroke-width="28" stroke-linecap="round" stroke-linejoin="round"/>
    <path id="path-dim"     fill="none" stroke="var(--track-color)" stroke-width="9" stroke-linecap="round" stroke-linejoin="round" opacity="0.15"/>
    <path id="path-elapsed" fill="none" stroke="var(--track-color)" stroke-width="9" stroke-linecap="round" stroke-linejoin="round" filter="url(#glow)"/>
    <g id="labels-group"></g>
    <polygon id="car" points="0,-9 6,6 -6,6" fill="white" filter="url(#glow-strong)"/>
  </svg>
</div>

<div class="stats">
  <div class="stat"><span class="stat-label">Total</span><span class="stat-value" id="stat-total">00:25:00</span></div>
  <div class="stat"><span class="stat-label">Elapsed</span><span class="stat-value accent" id="stat-elapsed">00:00:00</span></div>
  <div class="stat"><span class="stat-label">Remaining</span><span class="stat-value green" id="stat-remaining">00:25:00</span></div>
</div>

<div class="timer-row" id="timer-row">
  <div class="timer-input-wrap">
    <label>Time</label>
    <div class="time-field"><input type="number" id="in-hr"  value="00" min="0" max="23"><span class="time-field-label">HR</span></div>
    <span class="timer-sep">:</span>
    <div class="time-field"><input type="number" id="in-min" value="25" min="0" max="59"><span class="time-field-label">MIN</span></div>
    <span class="timer-sep">:</span>
    <div class="time-field"><input type="number" id="in-sec" value="00" min="0" max="59"><span class="time-field-label">SEC</span></div>
  </div>
</div>

<div class="controls">
  <button class="btn btn-primary" id="btn-start">START ENGINE</button>
  <button class="btn btn-ghost"   id="btn-reset">RST</button>
  <div class="palette-wrap">
    <div class="palette-btn" id="palette-btn"></div>
    <div class="palette-popup" id="palette-popup"></div>
  </div>
</div>

<div class="overlay overlay-pitstop" id="overlay-pitstop">
  <div class="pit-label">PIT STOP</div>
  <div class="tire-wrap">
    <div class="tire-spinning-group">
      <div class="tire-outer"></div>
      <div class="tire-rim"></div>
    </div>
    <div class="tire-hub"></div>
  </div>
  <button class="btn-back" id="btn-back-to-race">BACK TO RACE</button>
</div>

<div class="overlay overlay-finish" id="overlay-finish">
  <canvas id="flag-canvas" width="180" height="112"></canvas>
  <div class="winner-text" id="winner-text">Monaco GP<br>WINNER!</div>
  <div class="race-completed">Race Completed</div>
  <button class="btn-finish-back" id="btn-finish-back">NEW RACE</button>
</div>

<canvas id="confetti-canvas"></canvas>

<script>
const CIRCUITS=[
  {id:'abu-dhabi',flag:'ðŸ‡¦ðŸ‡ª',name:'Abu Dhabi GP',round:'R24',path:`M 60,140 L 180,140 Q 200,140 210,128 L 220,110 Q 226,96 238,90 Q 252,84 266,88 Q 280,92 284,106 Q 288,120 278,130 Q 268,140 252,140 L 232,140 Q 218,140 214,128 L 210,116 Q 208,104 218,98 Q 228,92 238,96 L 250,106 Q 258,116 250,126 L 238,134 Q 226,140 212,140 L 180,140 L 160,150 Q 140,158 118,152 Q 96,146 88,128 L 80,110 Q 76,94 86,84 Q 96,74 110,76 Q 126,78 130,92 Q 134,106 122,114 Q 110,120 98,114 L 86,104 Q 76,92 80,80 L 90,70 Q 104,62 118,66 L 140,72 Q 158,80 162,96 L 164,114 Q 164,130 152,138 L 140,144 L 120,148 L 100,148 L 80,144 L 64,140 L 60,140`,labels:[{t:'YAS MARINA',x:185,y:80},{t:'MARINA',x:120,y:60},{t:'HAIRPIN',x:248,y:155}]},
  {id:'australia',flag:'ðŸ‡¦ðŸ‡º',name:'Australia GP',round:'R1',path:`M 50,150 L 140,150 Q 160,150 168,136 L 178,118 Q 184,104 196,98 Q 210,92 224,98 Q 238,104 240,120 L 238,138 Q 234,152 218,156 L 196,158 Q 178,158 168,146 L 162,134 Q 158,120 168,112 Q 178,104 190,108 L 202,118 Q 208,128 200,136 L 188,142 L 174,146 L 156,148 L 138,146 Q 122,140 116,126 L 108,106 Q 102,88 112,76 Q 124,64 140,68 Q 154,72 156,88 L 154,104 Q 150,118 136,122 L 120,124 Q 104,122 98,108 L 96,92 Q 96,78 108,72 L 124,68 L 144,66 L 164,68 L 182,76 L 194,88 Q 200,100 196,114`,labels:[{t:'ALBERT PARK',x:195,y:82},{t:'LAKE',x:140,y:100},{t:'CHICANE',x:200,y:155}]},
  {id:'azerbaijan',flag:'ðŸ‡¦ðŸ‡¿',name:'Azerbaijan GP',round:'R17',path:`M 30,130 L 30,80 Q 30,62 46,56 L 80,50 L 200,50 Q 218,50 224,64 L 228,84 L 228,100 Q 228,114 216,120 L 200,124 L 180,126 Q 162,126 158,112 L 158,96 Q 160,82 174,78 L 190,76 Q 204,76 208,90 L 208,104 Q 206,116 194,120 L 178,122 L 160,120 Q 148,116 146,102 L 148,84 Q 152,70 168,68 L 190,66 L 220,68 Q 234,72 238,88 L 240,108 L 238,130 Q 234,148 216,154 L 190,158 L 80,158 Q 50,158 36,144 L 30,130`,labels:[{t:'BAKU',x:130,y:42},{t:'CASTLE',x:185,y:140},{t:'STRAIGHT',x:60,y:170}]},
  {id:'bahrain',flag:'ðŸ‡§ðŸ‡­',name:'Bahrain GP',round:'R4',path:`M 55,140 L 170,140 Q 190,140 200,124 L 210,104 Q 218,86 236,80 Q 256,74 272,86 Q 286,98 282,118 Q 278,136 260,142 Q 242,148 228,136 Q 214,124 218,106 Q 222,90 238,86 Q 252,82 260,94 L 264,110 Q 264,124 252,130 L 234,134 Q 218,134 212,120 L 210,104 Q 210,88 224,82 Q 238,76 250,84 L 262,98 Q 268,112 258,122 L 242,130 L 220,136 L 196,138 Q 178,136 168,122 L 158,104 Q 150,84 132,76 Q 112,68 94,78 Q 76,90 76,110 Q 76,130 92,140 L 110,146 L 130,148 L 148,146 L 162,140`,labels:[{t:"BAHRAIN INT'L",x:185,y:68},{t:'TURN 1',x:270,y:150},{t:'HAIRPIN',x:90,y:60}]},
  {id:'belgium',flag:'ðŸ‡§ðŸ‡ª',name:'Belgium GP',round:'R13',path:`M 40,120 L 100,80 Q 118,68 140,72 L 160,80 Q 178,90 178,110 L 174,132 Q 168,150 148,156 L 126,158 Q 106,156 96,140 L 92,122 Q 92,104 108,98 L 128,96 Q 148,96 156,112 L 156,128 Q 152,144 136,148 L 114,148 Q 96,144 92,128 L 92,110 Q 94,94 110,88 L 132,86 L 160,90 Q 180,98 188,118 L 190,140 Q 190,162 170,172 L 140,178 L 110,176 Q 80,170 68,150 L 56,128 L 40,120`,labels:[{t:'SPA',x:120,y:60},{t:'EAU ROUGE',x:55,y:108},{t:'POUHON',x:160,y:170}]},
  {id:'brazil',flag:'ðŸ‡§ðŸ‡·',name:'Brazil GP',round:'R21',path:`M 50,130 L 150,130 Q 170,130 178,114 L 186,94 Q 192,76 210,70 Q 230,64 246,76 Q 260,88 256,108 L 248,128 Q 238,146 218,150 L 194,152 Q 172,150 162,134 L 158,116 Q 158,98 174,92 Q 190,86 202,96 L 210,112 Q 212,128 198,134 L 180,136 Q 164,132 160,116 L 160,98 Q 164,82 180,78 Q 196,74 206,86 L 214,102 Q 216,118 204,126 L 188,130 L 168,130 L 140,126 Q 120,118 114,100 L 108,80 Q 106,60 122,52 Q 138,44 154,52 L 162,66 L 164,84`,labels:[{t:'INTERLAGOS',x:195,y:58},{t:'SENNA S',x:130,y:112},{t:'BICO DE PATO',x:155,y:148}]},
  {id:'canada',flag:'ðŸ‡¨ðŸ‡¦',name:'Canada GP',round:'R10',path:`M 50,140 L 160,140 Q 180,140 188,124 L 196,104 L 200,80 Q 200,62 216,56 L 240,54 Q 258,54 264,70 L 264,92 L 258,114 Q 252,132 234,138 L 210,142 L 186,142 Q 168,140 160,124 L 156,106 Q 154,88 166,80 L 184,76 Q 202,74 208,90 L 208,108 Q 204,124 188,128 L 168,128 Q 152,124 150,108 L 152,90 Q 156,74 172,70 L 192,68 L 214,70 L 232,80 Q 244,92 240,108 L 236,124 Q 228,138 210,140 L 188,142 L 158,142 L 120,144 Q 90,144 74,130 L 60,114 L 50,98 L 50,140`,labels:[{t:'GILLES VILLENEUVE',x:180,y:44},{t:'WALL OF CHAMP.',x:230,y:150},{t:'HAIRPIN',x:60,y:80}]},
  {id:'china',flag:'ðŸ‡¨ðŸ‡³',name:'China GP',round:'R2',path:`M 50,140 L 180,140 Q 200,140 210,124 L 218,104 Q 224,86 240,80 Q 258,74 272,86 Q 286,100 280,120 Q 274,140 254,146 Q 232,152 218,138 L 210,122 Q 208,104 222,98 Q 236,92 246,102 L 250,118 Q 248,132 234,136 L 214,136 Q 198,130 196,114 L 198,96 Q 204,80 220,76 Q 238,72 248,84 L 256,100 Q 258,118 244,128 L 224,134 L 196,136 Q 174,132 164,114 L 156,92 Q 150,70 132,62 Q 112,54 94,66 Q 76,80 80,102 Q 84,124 104,134 L 126,140 L 150,142`,labels:[{t:'SHANGHAI',x:210,y:68},{t:'TURN 1',x:270,y:150},{t:'HAIRPIN',x:75,y:50}]},
  {id:'hungary',flag:'ðŸ‡­ðŸ‡º',name:'Hungary GP',round:'R14',path:`M 60,130 L 150,130 Q 170,130 178,114 L 186,96 Q 192,80 208,76 Q 226,72 236,86 Q 246,100 240,118 Q 234,136 216,140 L 194,140 Q 176,138 170,122 L 168,104 Q 170,88 186,84 Q 202,80 210,94 L 212,110 Q 210,124 196,128 L 176,128 Q 160,122 158,106 L 160,88 Q 166,72 184,68 L 208,68 Q 228,70 236,88 L 238,108 Q 236,128 218,136 L 194,140 L 168,140 L 140,136 Q 118,126 112,106 L 108,84 Q 108,62 128,54 Q 148,46 164,58 L 170,74 L 168,92`,labels:[{t:'HUNGARORING',x:195,y:58},{t:'TURN 1',x:250,y:150},{t:'HAIRPIN',x:118,y:44}]},
  {id:'imola',flag:'ðŸ‡®ðŸ‡¹',name:'Imola GP',round:'R7',path:`M 55,135 L 145,135 Q 165,135 172,119 L 178,100 Q 182,84 196,78 Q 212,72 224,84 Q 236,96 230,114 Q 224,132 206,136 L 184,136 Q 166,132 162,116 L 162,98 Q 166,84 182,80 Q 198,76 206,90 L 208,106 Q 206,120 192,124 L 172,124 Q 156,118 154,102 L 156,84 Q 162,68 180,64 Q 198,60 210,72 L 218,90 L 218,112 Q 214,130 196,138 L 170,140 L 144,138 Q 122,130 114,110 L 108,88 Q 106,66 122,56 Q 140,46 156,56 L 162,72 L 160,92`,labels:[{t:'IMOLA',x:200,y:58},{t:'TAMBURELLO',x:65,y:118},{t:'VARIANTE ALTA',x:185,y:148}]},
  {id:'japan',flag:'ðŸ‡¯ðŸ‡µ',name:'Japan GP',round:'R3',path:`M 50,130 L 130,130 L 130,90 Q 130,72 146,66 L 170,64 Q 188,64 194,80 L 194,100 Q 190,116 174,118 L 156,116 Q 142,108 142,92 L 144,76 Q 150,62 166,60 L 188,62 Q 206,68 208,86 L 206,106 Q 200,124 182,126 L 158,126 Q 138,120 134,102 L 134,80 L 138,60 Q 144,42 162,38 Q 182,34 194,48 L 198,68 L 196,92 Q 192,114 172,122 L 148,126 L 124,124 Q 100,116 94,96 L 92,72 Q 94,50 114,44 Q 136,38 148,56 L 150,76 L 148,96 Q 144,114 126,120 L 100,124 L 76,120 Q 56,110 54,90 L 56,68 L 66,52 L 50,130`,labels:[{t:'SUZUKA',x:175,y:28},{t:'130R',x:58,y:100},{t:'DEGNER',x:195,y:120}]},
  {id:'las-vegas',flag:'ðŸ‡ºðŸ‡¸',name:'Las Vegas GP',round:'R22',path:`M 40,160 L 40,60 Q 40,46 54,42 L 80,40 L 290,40 Q 308,40 314,56 L 316,80 L 316,100 Q 316,114 302,118 L 276,120 Q 260,118 256,104 L 256,88 Q 258,74 272,70 L 294,68 Q 308,70 312,86 L 312,104 Q 308,118 294,122 L 268,124 L 240,122 Q 224,116 220,100 L 220,80 L 224,60 L 230,46 L 80,46 L 60,50 L 46,66 L 46,160 L 290,160 Q 310,160 318,144 L 320,120`,labels:[{t:'LAS VEGAS STRIP',x:165,y:32},{t:'TURN 1',x:40,y:40},{t:'STRAIGHT',x:165,y:172}]},
  {id:'mexico',flag:'ðŸ‡²ðŸ‡½',name:'Mexico GP',round:'R20',path:`M 50,140 L 160,140 Q 180,140 188,124 L 196,104 Q 202,86 220,80 Q 240,74 254,88 Q 268,102 262,122 Q 256,142 236,146 L 210,148 Q 188,146 178,128 L 174,110 Q 174,92 190,86 Q 208,80 218,94 L 222,110 Q 220,126 204,130 L 182,130 Q 166,124 164,108 L 166,90 Q 172,74 190,70 L 216,68 Q 238,70 248,88 L 250,110 Q 248,132 228,140 L 200,144 L 168,144 L 120,146 Q 88,144 70,126 L 56,106 L 50,86 L 50,140`,labels:[{t:'HERMANOS RODRIGUEZ',x:195,y:58},{t:'FORO SOL',x:230,y:155},{t:'ESSES',x:60,y:90}]},
  {id:'miami',flag:'ðŸ‡ºðŸ‡¸',name:'Miami GP',round:'R6',path:`M 40,150 L 200,150 Q 224,150 232,132 L 238,112 L 240,90 Q 240,70 258,64 L 284,62 Q 304,64 310,84 L 310,108 Q 308,130 288,136 L 260,138 Q 238,136 230,116 L 228,96 Q 230,78 248,74 Q 266,70 272,86 L 272,102 Q 268,114 254,116 L 236,114 Q 222,108 222,92 L 224,76 Q 230,62 248,60 L 274,60 Q 296,62 304,82 L 306,104 Q 304,128 282,136 L 252,140 L 220,140 L 180,142 Q 140,142 118,128 L 96,110 Q 74,88 68,64 Q 64,42 80,32 Q 98,22 116,34 L 122,52 L 118,72 Q 112,90 96,96 L 72,100 L 50,98 L 40,110 L 40,150`,labels:[{t:"MIAMI INT'L",x:250,y:50},{t:'TURN 1',x:50,y:88},{t:'MARINA',x:160,y:130}]},
  {id:'monaco',flag:'ðŸ‡²ðŸ‡¨',name:'Monaco GP',round:'R8',path:`M 55,148 L 155,148 Q 175,148 188,135 L 205,112 Q 218,96 228,88 Q 242,76 260,74 Q 280,72 296,84 Q 310,95 308,113 L 300,130 Q 292,143 276,146 Q 258,149 246,138 Q 234,127 237,111 Q 240,96 254,91 Q 262,88 271,93 L 285,107 Q 291,118 284,129 L 272,141 Q 261,150 245,153 L 198,156 Q 180,158 163,150 Q 148,143 140,129 L 122,104 Q 112,90 100,85 Q 86,80 74,87 Q 60,96 58,113 Q 56,128 64,138 Q 72,148 88,150 L 108,150 L 130,150 L 155,148`,labels:[{t:'CASINO',x:252,y:70},{t:'GRAND HOTEL',x:262,y:163},{t:'RASCASSE',x:44,y:163},{t:'STE DEVOTE',x:196,y:100}]},
  {id:'monza',flag:'ðŸ‡®ðŸ‡¹',name:'Monza GP',round:'R16',path:`M 50,120 L 290,120 Q 312,120 318,100 L 318,78 Q 316,58 296,54 L 266,52 Q 244,54 238,74 L 238,96 Q 240,116 260,122 L 284,124 Q 306,122 314,102 L 314,80 Q 310,60 290,56 L 260,54 L 238,58 L 220,72 L 210,92 L 210,112 Q 212,128 228,134 L 250,136 L 274,134 Q 294,128 298,108 L 298,86 Q 294,66 274,60 L 248,58 L 220,62 Q 196,72 192,96 L 192,120 L 80,120 Q 56,118 48,98 L 50,78 Q 54,60 74,56 L 100,54 Q 122,56 126,76 L 124,98 Q 120,116 100,120 L 74,120`,labels:[{t:'MONZA',x:185,y:40},{t:'LESMO',x:300,y:140},{t:'PARABOLICA',x:75,y:40}]},
  {id:'netherlands',flag:'ðŸ‡³ðŸ‡±',name:'Netherlands GP',round:'R15',path:`M 55,140 L 155,140 Q 175,140 182,124 L 188,104 Q 192,86 208,80 Q 226,74 238,88 Q 250,102 244,122 Q 238,140 218,144 L 194,144 Q 174,140 168,122 L 166,104 Q 168,86 184,80 Q 202,76 212,90 L 214,108 Q 212,124 196,128 L 174,128 Q 158,122 156,106 L 158,88 Q 164,72 182,68 Q 202,64 214,78 L 220,96 L 218,116 Q 212,134 192,140 L 162,142 L 120,142 Q 88,140 72,120 L 62,100 L 56,80 Q 56,60 74,52 Q 94,44 110,56 L 114,76 L 110,96 Q 104,114 84,118 L 60,118 L 55,140`,labels:[{t:'ZANDVOORT',x:195,y:55},{t:'TARZAN',x:235,y:155},{t:'SCHEIVLAK',x:65,y:44}]},
  {id:'qatar',flag:'ðŸ‡¶ðŸ‡¦',name:'Qatar GP',round:'R23',path:`M 50,130 L 200,130 Q 224,130 232,112 L 238,90 Q 242,70 260,64 Q 280,58 294,72 Q 308,88 302,110 Q 296,130 274,136 L 248,138 Q 224,136 216,116 L 214,94 Q 216,74 234,68 Q 254,62 264,78 L 266,96 Q 264,112 248,116 L 228,116 Q 212,110 210,92 L 212,74 Q 218,58 236,54 Q 258,50 270,66 L 274,86 Q 274,108 256,118 L 230,122 L 200,122 Q 170,120 156,100 L 148,76 Q 144,52 162,44 Q 182,36 196,50 L 200,70 L 196,92 Q 190,110 170,116 L 140,118 L 100,118 Q 68,114 56,94 L 50,74 L 50,130`,labels:[{t:'LUSAIL',x:215,y:44},{t:'TURN 1',x:290,y:148},{t:'BACK STRAIGHT',x:110,y:105}]},
  {id:'saudi',flag:'ðŸ‡¸ðŸ‡¦',name:'Saudi Arabia GP',round:'R5',path:`M 35,155 L 35,55 Q 35,40 50,36 L 80,34 L 300,34 Q 318,34 322,52 L 322,80 L 320,104 Q 318,120 302,124 L 278,126 Q 260,124 256,108 L 256,90 Q 258,74 276,70 L 298,68 Q 316,70 320,88 L 318,106 Q 314,122 296,126 L 270,128 L 240,126 Q 222,120 218,102 L 218,82 L 222,64 L 80,40 L 52,44 L 42,60 L 42,155 L 300,155 Q 318,153 322,136 L 322,120`,labels:[{t:'JEDDAH CORNICHE',x:165,y:26},{t:'TURN 1',x:35,y:42},{t:'STRAIGHT',x:165,y:167}]},
  {id:'singapore',flag:'ðŸ‡¸ðŸ‡¬',name:'Singapore GP',round:'R18',path:`M 40,140 L 140,140 Q 162,140 168,122 L 172,100 L 170,78 Q 168,60 184,54 L 210,52 Q 230,54 234,72 L 232,96 Q 228,116 208,120 L 184,120 Q 166,114 164,96 L 166,78 Q 172,62 190,60 Q 210,58 216,76 L 214,96 Q 210,112 192,116 L 168,116 Q 150,108 148,90 L 150,70 Q 156,52 176,48 Q 198,44 208,60 L 212,80 L 208,104 Q 202,124 180,130 L 152,134 L 120,136 L 88,134 Q 60,126 50,104 L 44,80 Q 42,56 60,48 Q 80,40 96,54 L 98,74 L 94,96 Q 88,114 68,116 L 44,114 L 40,130 L 40,140`,labels:[{t:'MARINA BAY',x:190,y:42},{t:'TURN 1',x:42,y:42},{t:'PIT STRAIGHT',x:140,y:152}]},
  {id:'spain',flag:'ðŸ‡ªðŸ‡¸',name:'Spain GP',round:'R9',path:`M 50,135 L 170,135 Q 192,135 200,118 L 208,98 Q 214,80 232,74 Q 252,68 266,82 Q 280,96 274,116 Q 268,136 248,140 L 224,142 Q 202,140 194,122 L 192,104 Q 194,86 212,80 Q 230,76 238,92 L 238,110 Q 234,126 216,130 L 194,130 Q 178,122 176,106 L 178,88 Q 184,72 202,68 L 226,66 Q 248,68 256,88 L 256,110 Q 252,132 230,140 L 200,144 L 166,144 L 120,144 Q 86,140 70,118 L 58,96 L 50,74 Q 50,54 68,48 Q 88,42 102,56 L 106,76 L 102,96 Q 96,114 76,118 L 52,118 L 50,135`,labels:[{t:'BARCELONA',x:210,y:56},{t:'TURN 1',x:272,y:152},{t:'TURN 10',x:64,y:42}]},
  {id:'uk',flag:'ðŸ‡¬ðŸ‡§',name:'UK GP',round:'R12',path:`M 50,130 L 180,130 Q 204,130 212,112 L 218,90 Q 222,70 240,64 Q 262,58 274,74 Q 286,90 278,112 Q 270,132 248,136 L 220,136 Q 198,132 192,112 L 190,92 Q 192,74 210,68 Q 230,62 240,78 L 242,96 Q 238,114 220,118 L 198,118 Q 180,110 178,92 L 180,72 Q 186,54 206,50 Q 228,46 238,62 L 240,82 L 236,104 Q 228,122 208,128 L 180,130 L 120,132 Q 86,130 68,108 L 56,84 Q 50,60 66,50 Q 86,40 100,54 L 102,76 L 98,98 Q 90,116 68,118 L 50,116 L 50,130`,labels:[{t:'SILVERSTONE',x:218,y:44},{t:'COPSE',x:275,y:148},{t:'MAGGOTTS',x:64,y:42}]},
  {id:'usa',flag:'ðŸ‡ºðŸ‡¸',name:'USA GP',round:'R19',path:`M 50,140 L 160,140 Q 182,140 190,122 L 196,100 Q 200,80 218,74 Q 238,68 252,82 Q 266,96 260,118 Q 254,138 232,142 L 206,144 Q 184,142 176,124 L 174,104 Q 176,84 194,78 Q 214,72 224,88 L 226,106 Q 222,124 204,128 L 180,128 Q 162,120 162,102 L 164,82 Q 170,64 190,60 Q 212,56 222,72 L 224,92 L 220,114 Q 212,132 192,138 L 162,142 L 120,142 Q 84,138 68,116 L 56,92 L 50,68 Q 50,48 68,42 Q 90,36 104,50 L 106,72 L 102,96 Q 96,116 74,120 L 50,118 L 50,140`,labels:[{t:'COTA',x:210,y:46},{t:'TURN 1',x:264,y:154},{t:'BACK STRAIGHT',x:65,y:38}]},
];
CIRCUITS.sort((a,b)=>a.name.localeCompare(b.name));

const PAGE_SIZE=6;
let currentPage=0,currentCircuitId='monaco';

function totalPages(){return Math.ceil(CIRCUITS.length/PAGE_SIZE);}

function renderDropdown(){
  const pg=document.getElementById('dropdown-page');
  const start=currentPage*PAGE_SIZE;
  pg.innerHTML='';
  CIRCUITS.slice(start,start+PAGE_SIZE).forEach(c=>{
    const item=document.createElement('div');
    item.className='dropdown-item'+(c.id===currentCircuitId?' active':'');
    item.innerHTML=`<span class="dropdown-flag">${c.flag}</span><span class="dropdown-name">${c.name}</span><span class="dropdown-round">${c.round}</span>`;
    item.addEventListener('click',()=>selectCircuit(c.id));
    pg.appendChild(item);
  });
  document.getElementById('nav-page').textContent=`${currentPage+1} / ${totalPages()}`;
  document.getElementById('nav-prev').disabled=currentPage===0;
  document.getElementById('nav-next').disabled=currentPage>=totalPages()-1;
}

function selectCircuit(id){
  currentCircuitId=id;
  const c=CIRCUITS.find(x=>x.id===id);
  document.getElementById('circuit-flag').textContent=c.flag;
  document.getElementById('circuit-title').textContent=c.name;
  document.getElementById('circuit-dropdown').classList.remove('open');
  document.getElementById('circuit-arrow').classList.remove('open');
  renderTrack(c);reset();
}

document.getElementById('circuit-btn').addEventListener('click',e=>{
  e.stopPropagation();
  const dd=document.getElementById('circuit-dropdown');
  const arrow=document.getElementById('circuit-arrow');
  const isOpen=dd.classList.toggle('open');
  arrow.classList.toggle('open',isOpen);
  if(isOpen)renderDropdown();
});
document.getElementById('nav-prev').addEventListener('click',e=>{e.stopPropagation();if(currentPage>0){currentPage--;renderDropdown();}});
document.getElementById('nav-next').addEventListener('click',e=>{e.stopPropagation();if(currentPage<totalPages()-1){currentPage++;renderDropdown();}});
document.addEventListener('click',()=>{document.getElementById('circuit-dropdown').classList.remove('open');document.getElementById('circuit-arrow').classList.remove('open');});

function renderTrack(c){
  document.getElementById('path-shadow').setAttribute('d',c.path);
  document.getElementById('path-dim').setAttribute('d',c.path);
  document.getElementById('path-elapsed').setAttribute('d',c.path);
  const g=document.getElementById('labels-group');g.innerHTML='';
  (c.labels||[]).forEach(l=>{
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',l.x);t.setAttribute('y',l.y);
    t.setAttribute('fill','var(--track-color)');t.setAttribute('font-size','9');
    t.setAttribute('font-family','Rajdhani,sans-serif');t.setAttribute('font-weight','700');
    t.setAttribute('opacity','0.9');t.setAttribute('text-anchor','middle');
    t.textContent=l.t;g.appendChild(t);
  });
  initTrack();updateCarPosition(0);
}

const TEAMS=[
  {name:'Mercedes',color:'#00D7B6'},
  {name:'Red Bull',color:'#4781D7'},
  {name:'Ferrari',color:'#ED1131'},
  {name:'McLaren',color:'#F47600'},
  {name:'Alpine',color:'#00A1E8'},
  {name:'Racing Bulls',color:'#6C98FF'},
  {name:'Aston Martin',color:'#229971'},
  {name:'Williams',color:'#1868DB'},
  {name:'Kick Sauber',color:'#01C00E'},
  {name:'Haas',color:'#9C9FA2'},
];
let selectedTeam=0;
function buildPalette(){
  const popup=document.getElementById('palette-popup');popup.innerHTML='';
  TEAMS.forEach((team,i)=>{
    const wrap=document.createElement('div');wrap.className='team-swatch';
    const dot=document.createElement('div');dot.className='swatch-dot'+(i===selectedTeam?' selected':'');
    dot.style.background=team.color;
    const lbl=document.createElement('div');lbl.className='swatch-label';lbl.textContent=team.name;
    wrap.appendChild(dot);wrap.appendChild(lbl);
    wrap.addEventListener('click',()=>{selectedTeam=i;applyColor(team.color);buildPalette();document.getElementById('palette-popup').classList.remove('open');});
    popup.appendChild(wrap);
  });
}
function applyColor(hex){
  document.documentElement.style.setProperty('--track-color',hex);
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  document.documentElement.style.setProperty('--track-glow',`rgba(${r},${g},${b},0.4)`);
  document.getElementById('palette-btn').style.background=hex;
}
document.getElementById('palette-btn').addEventListener('click',e=>{e.stopPropagation();document.getElementById('palette-popup').classList.toggle('open');});

const flagCanvas=document.getElementById('flag-canvas');
const flagCtx=flagCanvas.getContext('2d');
const COLS=14,ROWS=9,CW=flagCanvas.width,CH=flagCanvas.height;
let flagAnimId=null;
function drawWavingFlag(ts){
  const t=ts/700;flagCtx.clearRect(0,0,CW,CH);
  const cW=CW/COLS,cH=CH/ROWS;
  for(let row=0;row<ROWS;row++)for(let col=0;col<COLS;col++){
    const wA=(col/COLS)*10,wY=Math.sin(t+col*0.6)*wA,wS=1-Math.abs(Math.cos(t+col*0.6))*0.12,sh=1-(col/COLS)*0.25;
    const isB=(col+row)%2===0;
    flagCtx.fillStyle=isB?`rgb(${Math.round(20*sh)},${Math.round(20*sh)},${Math.round(20*sh)})`:`rgb(${Math.round(240*sh)},${Math.round(240*sh)},${Math.round(240*sh)})`;
    flagCtx.fillRect(col*cW,row*cH+wY,cW+0.5,cH*wS+0.5);
  }
  flagAnimId=requestAnimationFrame(drawWavingFlag);
}
function startFlagWave(){if(flagAnimId)cancelAnimationFrame(flagAnimId);flagAnimId=requestAnimationFrame(drawWavingFlag);}
function stopFlagWave(){if(flagAnimId)cancelAnimationFrame(flagAnimId);flagAnimId=null;flagCtx.clearRect(0,0,CW,CH);}

let trackLen=0;
function initTrack(){
  const p=document.getElementById('path-shadow');
  trackLen=p.getTotalLength();
  const el=document.getElementById('path-elapsed');
  el.style.strokeDasharray=trackLen;el.style.strokeDashoffset=trackLen;
}
function updateCarPosition(fraction){
  const p=document.getElementById('path-shadow');
  const len=p.getTotalLength(),dist=fraction*len;
  const pt=p.getPointAtLength(dist),d=4;
  const p1=p.getPointAtLength(Math.max(0,dist-d)),p2=p.getPointAtLength(Math.min(len,dist+d));
  const angle=Math.atan2(p2.y-p1.y,p2.x-p1.x)*180/Math.PI+90;
  document.getElementById('car').setAttribute('transform',`translate(${pt.x},${pt.y}) rotate(${angle})`);
  document.getElementById('path-elapsed').style.strokeDashoffset=trackLen*(1-fraction);
}

let totalSec=25*60,elapsed=0,interval=null,running=false,pomCount=0;
const MAX_POMS=4;
function pad(n){return String(Math.floor(n)).padStart(2,'0');}
function fmtFull(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return`${pad(h)}:${pad(m)}:${pad(sc)}`;}
function updateUI(){
  const rem=Math.max(0,totalSec-elapsed);
  document.getElementById('stat-total').textContent=fmtFull(totalSec);
  document.getElementById('stat-elapsed').textContent=fmtFull(elapsed);
  document.getElementById('stat-remaining').textContent=fmtFull(rem);
}
function buildDots(){
  const c=document.getElementById('lap-dots');c.innerHTML='';
  for(let i=0;i<MAX_POMS;i++){
    const d=document.createElement('div');
    d.className='lap-dot'+(i<pomCount?' done':(i===pomCount&&running?' active':''));
    c.appendChild(d);
  }
}
['in-hr','in-min','in-sec'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('blur',()=>{el.value=pad(parseInt(el.value)||0);});
  el.addEventListener('focus',()=>{el.select();});
});
function readInputSecs(){
  return (parseInt(document.getElementById('in-hr').value)||0)*3600
       + (parseInt(document.getElementById('in-min').value)||0)*60
       + (parseInt(document.getElementById('in-sec').value)||0);
}
function showPitOverlay(){document.getElementById('overlay-pitstop').classList.add('active');}
function hidePitOverlay(){document.getElementById('overlay-pitstop').classList.remove('active');}

document.getElementById('btn-start').addEventListener('click',()=>{
  if(running){clearInterval(interval);running=false;document.getElementById('btn-start').textContent='RESUME';showPitOverlay();return;}
  hidePitOverlay();
  if(elapsed===0){
    totalSec=readInputSecs();if(totalSec<=0)totalSec=25*60;
    document.getElementById('timer-row').style.opacity='0.3';
    document.getElementById('timer-row').style.pointerEvents='none';
    updateUI();
  }
  running=true;document.getElementById('btn-start').textContent='PAUSE';buildDots();interval=setInterval(tick,1000);
});

document.getElementById('btn-back-to-race').addEventListener('click',()=>{
  hidePitOverlay();
  if(!running&&elapsed<totalSec){running=true;document.getElementById('btn-start').textContent='PAUSE';buildDots();interval=setInterval(tick,1000);}
});

document.getElementById('btn-finish-back').addEventListener('click',()=>{
  stopConfetti();stopFlagWave();
  document.getElementById('overlay-finish').classList.remove('active');
  document.getElementById('confetti-canvas').style.display='none';
  reset();
});

document.getElementById('btn-reset').addEventListener('click',reset);

function reset(){
  clearInterval(interval);running=false;elapsed=0;pomCount=0;
  document.getElementById('btn-start').textContent='START ENGINE';
  document.getElementById('timer-row').style.opacity='1';
  document.getElementById('timer-row').style.pointerEvents='all';
  hidePitOverlay();
  document.getElementById('overlay-finish').classList.remove('active');
  document.getElementById('confetti-canvas').style.display='none';
  stopConfetti();stopFlagWave();
  totalSec=readInputSecs()||25*60;
  updateUI();buildDots();initTrack();updateCarPosition(0);
}

function tick(){
  elapsed++;updateCarPosition(Math.min(elapsed/totalSec,1));updateUI();
  if(elapsed>=totalSec){clearInterval(interval);running=false;pomCount++;buildDots();showFinish();}
}

function showFinish(){
  const c=CIRCUITS.find(x=>x.id===currentCircuitId);
  document.getElementById('winner-text').innerHTML=`${c.name}<br>WINNER!`;
  document.getElementById('overlay-finish').classList.add('active');
  document.getElementById('confetti-canvas').style.display='block';
  startFlagWave();startConfetti();
}

let confettiId=null;
function startConfetti(){
  const canvas=document.getElementById('confetti-canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth;canvas.height=window.innerHeight;
  const colors=[getComputedStyle(document.documentElement).getPropertyValue('--track-color').trim(),'#ffffff','#FFD700','#FF6B35','#00D2BE'];
  const parts=Array.from({length:180},()=>({x:Math.random()*canvas.width,y:-20-Math.random()*200,w:Math.random()*10+4,h:Math.random()*5+2,color:colors[Math.floor(Math.random()*colors.length)],speed:Math.random()*3+1.5,angle:Math.random()*360,aSpeed:(Math.random()-.5)*6,swing:Math.random()*2.5}));
  (function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);let alive=false;
    parts.forEach(p=>{p.y+=p.speed;p.x+=Math.sin(p.y/28)*p.swing;p.angle+=p.aSpeed;if(p.y<canvas.height+20)alive=true;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.angle*Math.PI/180);ctx.fillStyle=p.color;ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);ctx.restore();});
    if(alive)confettiId=requestAnimationFrame(draw);else ctx.clearRect(0,0,canvas.width,canvas.height);
  })();
}
function stopConfetti(){if(confettiId)cancelAnimationFrame(confettiId);const cv=document.getElementById('confetti-canvas');cv.getContext('2d').clearRect(0,0,cv.width,cv.height);}

window.addEventListener('load',()=>{
  buildPalette();applyColor(TEAMS[0].color);
  renderTrack(CIRCUITS.find(x=>x.id==='monaco'));
  updateUI();buildDots();
});
</script>
</body>
</html>
